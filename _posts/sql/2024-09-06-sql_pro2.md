---
layout: single
title: '[MySQL] SQL 문법 및 예제 정리 - LAG, LEAD, WITH, JOIN'
excerpt: "실무 적용 및 SQL 코테 대비 위한 자료입니다."
categories: SQL
tag : [sql, sqld, certificate, 자격증, 실기, 작업형, 실무, 정리, 총정리, 문법, 기초, 란, 설명, 코딩테스트, 코테]
toc: true
toc_sticky: true
sidebar_main: true

date: 2024-09-06
last_modified_at: 2024-09-06
---

<br>

## LAG(), LEAD() 함수

- MySQL 8.0부터 지원되는 `LAG()`와 `LEAD()` 함수는 데이터 분석에서 매우 유용한 윈도우 함수입니다. 이 두 함수는 현재 행을 기준으로 이전 또는 다음 행의 값을 참조할 수 있게 해줍니다.

### 1. `LAG()` 함수: 이전 행 값 가져오기

- `LAG()` 함수는 현재 행에서 **이전 행**의 값을 가져옵니다. 주로 변화 추적이나, 연속된 데이터의 차이를 계산할 때 사용됩니다.

```sql
# 예시
SELECT
    id,
    value,
    LAG(value, 1, 0) OVER (ORDER BY id) AS previous_value
FROM
    your_table;
```

- 이 쿼리는 각 행에 대해 이전 행의 `value` 값을 `previous_value`로 반환합니다. 첫 번째 행은 이전 행이 없으므로 기본값 `0`이 반환됩니다.

> LAG() 함수에서 PARTITION BY와 ORDER BY를 함께 사용하면, 데이터셋을 특정 그룹으로 나누고 각 그룹 내에서 순서에 따라 이전 행의 값을 참조할 수 있습니다.
> 이 기능은 주로 그룹별로 데이터의 변화를 추적하거나 비교할 때 유용합니다.

### 2. `LEAD()` 함수: 다음 행 값 가져오기

- `LEAD()` 함수는 현재 행에서 **다음 행**의 값을 참조합니다. 이는 미래 데이터를 미리 보여주거나, 현재 행과 다음 행 간의 차이를 계산할 때 유용합니다.

```sql
# 예시
SELECT
    id,
    value,
    LEAD(value, 1, 0) OVER (ORDER BY id) AS next_value
FROM
    your_table;
```
- 이 쿼리는 각 행에 대해 다음 행의 `value` 값을 `next_value`로 반환합니다. 마지막 행은 다음 행이 없으므로 기본값 `0`이 반환됩니다.

<br>

### 3. 활용 사례: 현재 행에서 다음 행의 차이 계산

- 두 함수를 활용해 현재 행과 다음 행의 값을 비교할 수 있습니다.

```sql
# 예시
SELECT
    id,
    value,
    value - LEAD(value) OVER (ORDER BY id) AS difference_with_next
FROM
    your_table;
```
- 이 쿼리는 각 행의 `value` 값과 다음 행의 `value` 값의 차이를 계산하여 `difference_with_next` 열에 표시합니다.

<br>

## 날짜(Date) 및 시간(Timestamp)

- MySQL에는 날짜와 시간을 처리하기 위한 다양한 함수들이 있습니다. 
- 이 함수들은 날짜와 시간의 연산, 형식 변환, 추출 및 포맷팅 등을 손쉽게 수행할 수 있게 해줍니다. 
- 아래는 MySQL에서 자주 사용되는 날짜 관련 함수들입니다.

<br>

### 1. 날짜 및 시간의 추가와 차이 계산

- **`DATE_ADD()`**: 특정 날짜에 지정된 기간을 더합니다.
  ```sql
  SELECT DATE_ADD('2024-09-06', INTERVAL 10 DAY);  -- 2024-09-16
  ```
- **`DATE_SUB()`**: 특정 날짜에서 지정된 기간을 뺍니다.
  ```sql
  SELECT DATE_SUB('2024-09-06', INTERVAL 10 DAY);  -- 2024-08-27
  ```
- **`DATEDIFF()`**: 두 날짜 간의 차이를 일 단위로 반환합니다.
  ```sql
  SELECT DATEDIFF('2024-09-16', '2024-09-06');  -- 10
  ```
- **`TIMESTAMPDIFF()`**: 두 날짜 또는 시간 간의 차이를 지정된 단위(초, 분, 시간 등)로 반환합니다.
  ```sql
  SELECT TIMESTAMPDIFF(HOUR, '2024-09-06 08:00:00', '2024-09-06 14:00:00');  -- 6
  ```

<br>

### 2. 날짜 및 시간 형식 변환

- **`STR_TO_DATE()`**: 문자열을 날짜로 변환합니다.
  ```sql
  SELECT STR_TO_DATE('06-09-2024', '%d-%m-%Y');  -- 2024-09-06
  ```
- **`DATE_FORMAT()`**: 날짜를 지정된 형식의 문자열로 변환합니다.
  ```sql
  SELECT DATE_FORMAT('2024-09-06', '%M %d, %Y');  -- September 06, 2024
  ```
- **`TIME_FORMAT()`**: 시간을 지정된 형식의 문자열로 변환합니다.
  ```sql
  SELECT TIME_FORMAT('14:30:00', '%h:%i %p');  -- 02:30 PM
  ```
  
<br>

### 3. 날짜 및 시간 비교

- **`DATE()`**: `DATETIME`이나 `TIMESTAMP` 타입에서 날짜 부분만 반환합니다.
  ```sql
  SELECT DATE('2024-09-06 14:30:00');  -- 2024-09-06
  ```
- **`TIME()`**: `DATETIME`이나 `TIMESTAMP` 타입에서 시간 부분만 반환합니다.
  ```sql
  SELECT TIME('2024-09-06 14:30:00');  -- 14:30:00
  ```

<br>

## WITH 

- `WITH` 구문은 MySQL에서 **공통 테이블 표현식**(CTE, Common Table Expression)을 정의할 때 사용됩니다. 
- CTE는 복잡한 쿼리를 더 읽기 쉽고 관리하기 쉽게 만들어줍니다. 

### 1. 기본 개념

- **CTE 정의**: `WITH` 뒤에 CTE 이름과 그 정의를 작성합니다. 이는 일종의 임시 테이블로, 이후 메인 쿼리에서 참조할 수 있습니다.
- **구조**: 
  ```sql
  WITH cte_name AS (
      SELECT ... -- CTE 정의 쿼리
  )
  SELECT ...
  FROM cte_name;
  ```

<br>

### 2. 사용 사례

1. **복잡한 쿼리의 간소화**:
   CTE를 사용하면 서브쿼리의 중첩을 피하고, 복잡한 쿼리를 단계별로 분리하여 이해하기 쉽게 만들 수 있습니다.
  
2. **재사용 가능한 쿼리**:
   동일한 중간 결과를 여러 번 사용해야 할 때, CTE를 정의하고 이를 참조하면 중복된 코드를 줄일 수 있습니다.

<br>

```sql
# 예시
WITH AvgSalary AS (
    SELECT department_id, AVG(salary) AS avg_salary
    FROM employees
    GROUP BY department_id
)
SELECT employee_name, salary
FROM employees e
JOIN AvgSalary a ON e.department_id = a.department_id
WHERE e.salary > a.avg_salary;
-- CTE `AvgSalary`: 각 부서의 평균 급여를 계산
-- 메인 쿼리: 이 CTE를 참조해 평균 급여보다 높은 직원들을 선택
```

<br>

## JOIN

- 각각의 테이블을 콤마( , )를 이용해 이으면 모든 데이터가 서로 곱해서 출력됩니다.

```sql
--
SELECT * 
    FROM EMP, DEPT;
```



